<!DOCTYPE html>
{% extends "base.html" %}
{% load render_table from django_tables2 %}

<html lang="en">
<head>
  <meta charset="UTF-8">
    <title>NSTV~ Movie Index</title>
</head>
<body>
{% block content %}

<div class="action-container">
    <h4>üìÅ File Management</h4>
    <button id="move_files_to_plex" class="plex-action-btn">
        <span id="btn-text">üé¨ Move Downloaded Files to Plex</span>
        <span id="btn-spinner" style="display:none;">‚è≥ Moving...</span>
    </button>
    <p style="color: #666; font-size: 14px; margin-top: 10px;">
        Moves completed downloads from NZBGet to your Plex Movies library
    </p>
</div>

<script>
$("#move_files_to_plex").click(function() {
    // Disable button and show spinner
    let btn = $(this);
    btn.prop('disabled', true);
    $('#btn-text').hide();
    $('#btn-spinner').show();
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            let cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    let csrf_token = getCookie('csrftoken');
    
    $.ajax({
        type: "POST",
        url: "/movies/move_downloaded_files_to_plex",
        headers: {
            "X-CSRFToken": csrf_token
        },
        success: function(data) {
            // Reload page to show messages
            location.reload();
        },
        error: function(xhr, status, error) {
            let message = 'Failed to move files.';
            if (xhr.responseJSON?.message) {
                message = xhr.responseJSON.message;
            } else if (xhr.responseText) {
                try {
                    let response = JSON.parse(xhr.responseText);
                    message = response.status || response.message || message;
                } catch (e) {
                    message = 'Error parsing response: ' + e.toString();
                }
            }
            alert('Error: ' + message);
            btn.prop('disabled', false);
            $('#btn-text').show();
            $('#btn-spinner').hide();
        }
    });
});
</script>

<center>
    <h3>Movies</h3>
    {% render_table movies %}
</center>

{% endblock %}
